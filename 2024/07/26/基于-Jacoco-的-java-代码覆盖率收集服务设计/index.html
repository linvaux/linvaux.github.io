<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>基于 Jacoco 的 java 代码覆盖率收集服务设计 | 写bug的大耳朵图图</title>
  <meta name="description" content="背景下半年开始搞精准测试了，先搞一波代码覆盖率，因为公司绝大多数项目都是基于 Java 开发的，所以就先搞 Java 的了，主流的代码覆盖率工具是 Jacoco(其实我也只知道这一个)，所以就直接基于 springboot 搞一个吧。 代码覆盖率知识什么是代码覆盖率代码覆盖率(Code Coverage)是软件测试中一种衡量测试质量的指标，用于评估测试用例对源代码的覆盖程度。它衡量了在执行测试用例">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 Jacoco 的 java 代码覆盖率收集服务设计">
<meta property="og:url" content="https://linvaux.github.io/2024/07/26/%E5%9F%BA%E4%BA%8E-Jacoco-%E7%9A%84-java-%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1/index.html">
<meta property="og:site_name" content="写bug的大耳朵图图">
<meta property="og:description" content="背景下半年开始搞精准测试了，先搞一波代码覆盖率，因为公司绝大多数项目都是基于 Java 开发的，所以就先搞 Java 的了，主流的代码覆盖率工具是 Jacoco(其实我也只知道这一个)，所以就直接基于 springboot 搞一个吧。 代码覆盖率知识什么是代码覆盖率代码覆盖率(Code Coverage)是软件测试中一种衡量测试质量的指标，用于评估测试用例对源代码的覆盖程度。它衡量了在执行测试用例">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://linvaux.github.io/images/2iKFxtHv2H7AFD1wybrWrGG9.jpg">
<meta property="og:image" content="https://linvaux.github.io/images/yLm9v8FXQubNswNKX75cxkcu.jpg">
<meta property="og:image" content="https://linvaux.github.io/images/3QSitfQz8xy1rjrZeT1Loxhs.png">
<meta property="og:image" content="https://linvaux.github.io/images/xKmTQwzgyHGMiDVCzNmwDe2z.png">
<meta property="og:image" content="https://linvaux.github.io/images/hCRXbhQguPR52jrdxQyekrM8.png">
<meta property="og:image" content="https://linvaux.github.io/images/WRMqo5DnDnHg7HgYi9BvcNbD.png">
<meta property="article:published_time" content="2024-07-26T15:04:46.000Z">
<meta property="article:modified_time" content="2024-08-03T01:25:42.021Z">
<meta property="article:author" content="Wick">
<meta property="article:tag" content="代码覆盖率">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://linvaux.github.io/images/2iKFxtHv2H7AFD1wybrWrGG9.jpg">
  <!-- Canonical links -->
  <link rel="canonical" href="https://linvaux.github.io/2024/07/26/%E5%9F%BA%E4%BA%8E-Jacoco-%E7%9A%84-java-%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1/index.html">
  
    <link rel="alternate" href="/atom.xml" title="写bug的大耳朵图图" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
<meta name="generator" content="Hexo 7.3.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://gitee.com/linvaux" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar1.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">大耳朵图图</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Java开发/高级测试开发</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> 中国·南京</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form" method="GET" action="https://www.baidu.com/s?">
	<div class="input-group">
    	<input name="wd" type="text" class="form-control search-form-input" placeholder="搜索" />
	    <span class="input-group-btn">
	    	<button type="submit" class=" btn btn-flat search-form-submit"><i class="icon icon-search"></i></button>
	    </span>
    </div>
</form>

</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://gitee.com/linvaux" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <h5>原博客地址：<a href = "https://geeknote.net/wick">https://geeknote.net/wick</a></h5>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Docker/" style="font-size: 13.75px;">Docker</a> <a href="/tags/EasyExcel/" style="font-size: 13.5px;">EasyExcel</a> <a href="/tags/IDEA/" style="font-size: 13.5px;">IDEA</a> <a href="/tags/Java/" style="font-size: 14px;">Java</a> <a href="/tags/Jenkins/" style="font-size: 13px;">Jenkins</a> <a href="/tags/Jmeter%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 13px;">Jmeter扩展开发</a> <a href="/tags/Jmeter%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/" style="font-size: 13.75px;">Jmeter源码系列</a> <a href="/tags/LogStash/" style="font-size: 13px;">LogStash</a> <a href="/tags/Mac/" style="font-size: 13px;">Mac</a> <a href="/tags/Pytest/" style="font-size: 13px;">Pytest</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87/" style="font-size: 13.25px;">代码覆盖率</a> <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 13px;">自动化测试</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a><span class="archive-list-count">29</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/08/03/%E3%80%90Jmeter%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E3%80%91%E8%87%AA%E5%AE%9A%E4%B9%89Java%E8%AF%B7%E6%B1%82/" class="title">【Jmeter扩展开发】自定义Java请求</a>
              </p>
              <p class="item-date">
                <time datetime="2024-08-03T01:36:37.000Z" itemprop="datePublished">2024-08-03</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/07/31/IDEA%E6%8F%92%E4%BB%B6%E6%95%B4%E7%90%86-%E4%BA%8C/" class="title">IDEA插件整理(二)</a>
              </p>
              <p class="item-date">
                <time datetime="2024-07-31T14:02:28.000Z" itemprop="datePublished">2024-07-31</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/07/28/Jmeter%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-4-Jmeter-%E7%B1%BB%E8%AF%A6%E8%A7%A3-runNonGui-%EF%BC%8C%E6%97%A0%E7%95%8C%E9%9D%A2%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/" class="title">Jmeter源码系列(4) - Jmeter 类详解-runNonGui()，无界面模式下的脚本执行过程</a>
              </p>
              <p class="item-date">
                <time datetime="2024-07-28T14:03:54.000Z" itemprop="datePublished">2024-07-28</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/07/26/Java%E9%9B%86%E6%88%90GradleToolingAPI%E7%BC%96%E8%AF%91Gradle%E9%A1%B9%E7%9B%AE/" class="title">Java集成GradleToolingAPI编译Gradle项目</a>
              </p>
              <p class="item-date">
                <time datetime="2024-07-26T15:15:50.000Z" itemprop="datePublished">2024-07-26</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2024/07/26/Jacocoagent-%E6%94%B9%E9%80%A0-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%A6%86%E7%9B%96%E7%8E%87%E6%95%B0%E6%8D%AE%E4%B8%8A%E6%8A%A5/" class="title">Jacocoagent 改造-服务端覆盖率数据上报</a>
              </p>
              <p class="item-date">
                <time datetime="2024-07-26T15:14:25.000Z" itemprop="datePublished">2024-07-26</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-基于-Jacoco-的-java-代码覆盖率收集服务设计" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      基于 Jacoco 的 java 代码覆盖率收集服务设计
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2024/07/26/%E5%9F%BA%E4%BA%8E-Jacoco-%E7%9A%84-java-%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1/" class="article-date">
	  <time datetime="2024-07-26T15:04:46.000Z" itemprop="datePublished">2024-07-26</time>
	</a>
</span>
        
        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87/" rel="tag">代码覆盖率</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2024/07/26/%E5%9F%BA%E4%BA%8E-Jacoco-%E7%9A%84-java-%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 7.1k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 28(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>下半年开始搞精准测试了，先搞一波代码覆盖率，因为公司绝大多数项目都是基于 Java 开发的，所以就先搞 Java 的了，主流的代码覆盖率工具是 Jacoco(其实我也只知道这一个)，所以就直接基于 springboot 搞一个吧。</p>
<h2 id="代码覆盖率知识"><a href="#代码覆盖率知识" class="headerlink" title="代码覆盖率知识"></a>代码覆盖率知识</h2><h3 id="什么是代码覆盖率"><a href="#什么是代码覆盖率" class="headerlink" title="什么是代码覆盖率"></a>什么是代码覆盖率</h3><p>代码覆盖率(Code Coverage)是软件测试中一种衡量测试质量的指标，用于评估测试用例对源代码的覆盖程度。它衡量了在执行测试用例时源代码中有多少行、分支、类、方法等被执行到。<br>无论是单元测试、API测试还是功能性测试，最终都是调用了产品的代码；如何评价这些测试的效率?这些测试是否真正全部或者大部分覆盖了产品的代码？这个时候，代码覆盖率就是一个比较有价值的参考指标了。<br>不同的代码覆盖率工具衡量指标可能不同。对于java语言，主流的代码覆盖率工具为Jacoco。当然，Jacoco其实是支持收集运行在JVM上的应用程序的覆盖率的。</p>
<h3 id="代码覆盖率的意义"><a href="#代码覆盖率的意义" class="headerlink" title="代码覆盖率的意义"></a>代码覆盖率的意义</h3><ol>
<li>测试视角：分析未覆盖部分的代码，从而反推在前期测试设计是否充分?没有覆盖到的代码是否是测试设计的盲点，为什么没有考虑到？是需求&#x2F;设计不够清晰，测试设计的理解有误？还是工程方法应用后造成的策略性放弃等等，方便之后进行测试用例设计补充。</li>
<li>开发视角：检测出程序中的废代码，可以逆向反推在代码设计中思维混乱点，提醒设计&#x2F;开发人员理清代码逻辑关系，提升代码质量。</li>
<li>其他视角：代码覆盖率高不能说明代码质量高，但是反过来看，代码覆盖率低，代码质量不会高到哪里去，可以作为测试&#x2F;开发自我审视的重要工具之一。<br>以上是代码覆盖率正面的意义，但是要注意一点：从质量的角度来说，肯定是希望用例能够对代码全部进行覆盖的，但是从实际出发，进行全覆盖也是不现实的，并且把测试覆盖率作为质量目标没有任何意义，而我们应该把它作为一种发现未被测试覆盖的代码的手段。从现有的覆盖率检测工具来看，即使覆盖率到达了100%，也不能保证用户场景完全被覆盖到或者不会出现漏测，因为从原理上来讲，代码覆盖率只能表示开发写的代码都执行了，但是不表示代码没有逻辑问题，如漏写异常处理，没有完全覆盖用户场景等。</li>
</ol>
<h3 id="代码覆盖率生成原理"><a href="#代码覆盖率生成原理" class="headerlink" title="代码覆盖率生成原理"></a>代码覆盖率生成原理</h3><p>Jacoco代码覆盖率生成主要由以下几个过程组成：</p>
<h4 id="1-代码插桩"><a href="#1-代码插桩" class="headerlink" title="1.代码插桩"></a>1.代码插桩</h4><p>插桩分为编译期插桩和运行期插桩，两者区别如下：</p>
<ul>
<li>编译期插桩（Offline模式）：在java源文件编译时，直接将桩插入代码行，编译后的class中已经包含了插桩代码，比如使用jacoco-maven-plugin插件即可实现编译期插桩。在Offline模式下，覆盖率数据是通过在编译期对字节码进行插桩生成的文件进行收集和分析。在编译阶段，Jacoco通过在Java字节码中插入代码来记录覆盖率信息。然后，在运行测试或应用程序之后，Jacoco使用已生成的覆盖率数据文件进行分析，生成相应的报告。由于覆盖率数据是在编译期收集并存储在文件中，这种模式可以在任何时候进行分析并生成报告，无需实时地收集覆盖率数据。这对于持续集成和定期报告生成非常有用。</li>
<li>运行期插桩（On-the-fly模式）：在应用程序运行期间，通过java agent技术，动态的对class文件做插桩，此类技术使用ASM框架实现，动态的修改了字节码文件。在On-the-fly模式下，覆盖率数据是在运行时实时收集并分析的。在应用程序运行时，Jacoco通过Java Agent技术加载到JVM中，并使用字节码插桩机制动态修改正在执行的字节码，以记录覆盖率信息。在应用程序运行期间，Jacoco会实时收集覆盖率数据并保存在内存中。一旦测试执行完成，覆盖率数据可以立即进行分析和报告。这种模式对于需要实时监控和反馈的场景非常有用，例如在开发过程中查看代码覆盖率。</li>
</ul>
<p>编译期插桩的优点是不需要在运行时进行字节码的修改，可以更方便地与构建工具（如Maven或Ant）集成，并且不会对运行时性能产生显著的影响。缺点是需要重新编译代码，并且生成的插桩后的字节码会增加项目的大小。</p>
<p>运行期插桩的优点是可以对已经编译的字节码进行插桩，无需重新编译代码。缺点是在每次运行应用程序时都需要加载Jacoco Agent，可能会对应用程序的运行时性能产生一定的影响。</p>
<h4 id="2-覆盖率数据收集"><a href="#2-覆盖率数据收集" class="headerlink" title="2.覆盖率数据收集"></a>2.覆盖率数据收集</h4><p>在On-the-fly模式下，覆盖率数据使用jacocoagent.jar来收集，此agent会伴随被测服务一起启动。</p>
<p>jacoco生成的覆盖率数据文件默认为exec格式，覆盖率数据输出方式有以下几种：</p>
<ul>
<li>file：JVM 终止时，执行数据将写入属性中指定的文件中destfile。</li>
<li>tcpserver：代理侦听由address和 port属性指定的 TCP 端口上的传入连接。执行数据写入此 TCP 连接。</li>
<li>tcpclient：启动时，代理连接到address和port 属性指定的 TCP 端口。执行数据写入此 TCP 连接。</li>
<li>none：不产生任何输出。</li>
</ul>
<p>一般对于服务端覆盖率数据收集，我们使用tcpserver模式，即jacocoagent跟着被测服务启动时，同时启动一个tcp端口(默认是6300)，后续可以通过jacococli或者其他工具访问6300端口来下载覆盖率数据。</p>
<h4 id="3-覆盖率报告生成"><a href="#3-覆盖率报告生成" class="headerlink" title="3.覆盖率报告生成"></a>3.覆盖率报告生成</h4><p>覆盖率数据报告生成需要借助jacococli.jar，先通过cli的dump命令获取覆盖率数据文件(即exec文件)，然后通过cli的report命令来生成覆盖率数据报告。</p>
<h3 id="全量覆盖率"><a href="#全量覆盖率" class="headerlink" title="全量覆盖率"></a>全量覆盖率</h3><p>适用场景：</p>
<ul>
<li>初次测试：当开始进行测试时，全量代码覆盖率非常有用。它可以确保测试用例覆盖了整个代码库，从而验证代码在各种场景下的正确性和稳定性。</li>
<li>重构和优化：在进行重构或性能优化时，全量代码覆盖率可以帮助发现可能引入的新问题，并确保代码的质量和性能未受到不良影响。</li>
<li>稳定版本验证：在发布稳定版本之前，全量代码覆盖率可用于验证所有已经修改或新增的功能的测试覆盖程度，以确保发布的版本是经过全面测试的。</li>
<li>其他需要全量回归的场景，如：机房迁移，新环境部署…</li>
</ul>
<h3 id="增量覆盖率"><a href="#增量覆盖率" class="headerlink" title="增量覆盖率"></a>增量覆盖率</h3><p>jacoco本身是不支持增量代码覆盖率的，但是可以通过二开或者使用其他的开源工具实现增量覆盖率报告生成。<br>适用场景：</p>
<ul>
<li>快速迭代测试：在项目快速迭代的情况下，仅针对新增或修改的代码进行增量代码覆盖率分析能够快速确定这些变动的测试覆盖程度，以便加快迭代速度。</li>
<li>高频更新验证：对于经常更新的代码库，每次都进行全量代码覆盖率分析可能会产生高昂的计算和执行成本。使用增量代码覆盖率可以更快地了解测试覆盖的变化情况，以便快速验证新增功能的正确性和稳定性。</li>
<li>增量测试补充：当时间有限而需求变动时，增量代码覆盖率可用于快速确定需求变动对现有测试覆盖的影响，并有针对性地补充和调整测试用例，以覆盖新增或修改的代码。</li>
</ul>
<h2 id="建设思路"><a href="#建设思路" class="headerlink" title="建设思路"></a>建设思路</h2><ul>
<li>目标：为整个中心不同部门&#x2F;项目组提供统一的Java 代码覆盖率收集能力</li>
<li>前期准备：</li>
</ul>
<ol>
<li>收集试点项目的技术栈，包括：开发框架，部署架构。</li>
<li>了解不同项目组对代码覆盖率的使用场景，比如 TL 关心开发提交的代码是否夹带私货，是否存在 dead code。测试人员或者产品经理关心是否测试全面，想通过代码的变更点推导出业务上的影响面。开发人员关心自己本个迭代提交的代码是否都测试完全等。</li>
</ol>
<ul>
<li>技术选型：</li>
</ul>
<ol>
<li>后端开发技术栈：Springboot，JacocoCli，Jgit，MavenCli，GradleToolingApi，MySQL，MyBatis</li>
<li>前端开发技术栈：vue2</li>
</ol>
<h2 id="应用架构设计-业务视角"><a href="#应用架构设计-业务视角" class="headerlink" title="应用架构设计(业务视角)"></a>应用架构设计(业务视角)</h2><p>业务架构图不方便贴，就说下基本流程：</p>
<ol>
<li>配置凭据，即Git 账号和密码，此处使用类似 Jenkins 凭据的方式来管理。</li>
<li>配置服务信息，如服务名称，git 仓库地址，环境类型，dump 端口(jacocoagent启动端口)，ip 列表(同一个服务在不同环境有不同 ip，而且可能是多实例部署)，选择凭据。</li>
<li>配置覆盖率采集任务，选择环境自动带出此环境下面的服务列表，填写任务名称，迭代信息，在选择服务的时候要选择分支，如果是增量覆盖率，则需要选择采集分支和基准分支，如果是全量覆盖率，则选择采集分支即可。</li>
<li>执行采集任务，生成执行记录和覆盖率报告。</li>
</ol>
<h2 id="应用架构设计-技术视角"><a href="#应用架构设计-技术视角" class="headerlink" title="应用架构设计(技术视角)"></a>应用架构设计(技术视角)</h2><p>代码覆盖率只是整个测试平台的一个服务，测试平台使用 SBA 架构(服务导向的架构)，整个平台架构图如下所示：</p>
<p><img src="/../images/2iKFxtHv2H7AFD1wybrWrGG9.jpg" alt="image.png"></p>
<p>代码覆盖率量子中只包含一个代码覆盖率容器，配合插件层的 jacocoagent 插件来协同工作。</p>
<h2 id="安全方案"><a href="#安全方案" class="headerlink" title="安全方案"></a>安全方案</h2><p>代码覆盖率收集服务，主要业务是：根据用户配置的代码库地址和GIT账密来收集 Java 应用服务在某个时间段内的代码覆盖情况。其中会涉及到用户在平台上填写以下数据：</p>
<ul>
<li>代码库地址(以下简称 代码库)</li>
<li>GIT账号和密码(以下简称 凭据)</li>
</ul>
<p>同时生成的覆盖率报告会包含部分&#x2F;所有的代码信息，因此需要对覆盖率报告也做数据权限的管控。<br>因为测试平台使用多租户模式，所以不同的租户下面数据是完全隔离的，不存在跨租户访问数据的情况，只需要解决水平越权和垂直越权的安全问题即可。</p>
<p>因为安全方案涉及到公司内部数据，所以只给出以下思路：</p>
<ol>
<li>菜单权限&#x2F;api权限：可以基于 Spring Security实现，或者其他安全框架实现</li>
<li>数据权限：对接口中的入参 by 租户进行校验，不允许访问未授权的测试库数据</li>
<li>数据安全：对 GIT 密码进行加密保存，可以选择 DES 或者 RSA 非对称加密</li>
</ol>
<h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h2><p><img src="/../images/yLm9v8FXQubNswNKX75cxkcu.jpg" alt="image.png"></p>
<h2 id="代码覆盖率收集过程"><a href="#代码覆盖率收集过程" class="headerlink" title="代码覆盖率收集过程"></a>代码覆盖率收集过程</h2><h3 id="Step-1：代码插桩"><a href="#Step-1：代码插桩" class="headerlink" title="Step-1：代码插桩"></a>Step-1：代码插桩</h3><p>代码覆盖率收集过程基于 jacoco 的插桩来实现，jacoco 支持 2 中插桩方式：</p>
<h4 id="On-the-fly-模式（即时模式）："><a href="#On-the-fly-模式（即时模式）：" class="headerlink" title="On-the-fly 模式（即时模式）："></a>On-the-fly 模式（即时模式）：</h4><p>插桩时机：在应用程序运行时，通过 Java 代理（Java Agent）将 JaCoCo 注入到 JVM 中。<br>数据收集方式：实时地收集代码覆盖率数据，即时生成运行时的覆盖率报告。</p>
<p>优点：</p>
<ul>
<li>可以实时地监测应用程序的执行和覆盖率情况。</li>
<li>不需要对代码进行重新编译，使得在现有项目中使用更为方便。</li>
</ul>
<p>缺点：</p>
<ul>
<li>在运行时对字节码进行修改，可能会对应用程序的性能产生一定影响。</li>
<li>数据收集和报告生成过程会占用一些 CPU 和内存资源。</li>
</ul>
<h4 id="Offline-模式（离线模式）："><a href="#Offline-模式（离线模式）：" class="headerlink" title="Offline 模式（离线模式）："></a>Offline 模式（离线模式）：</h4><p>插桩时机：在构建过程中对项目的字节码进行修改，通过构建工具（如 Maven 或 Gradle）进行插桩。<br>数据收集方式：在应用程序运行时，JaCoCo 会收集覆盖率数据并将其保存到执行文件中（通常是一个二进制格式的 .exec 文件）。</p>
<p>优点：</p>
<ul>
<li>不会对应用程序的运行性能造成直接影响。</li>
<li>可以在构建过程中自动插桩，方便集成到自动化构建和持续集成流程中。</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要对项目进行重新编译，可能会增加构建过程的时间和开销。</li>
<li>需要对执行文件进行处理，生成可读性更好的覆盖率报告。</li>
</ul>
<h3 id="Step-2：生成-exec-文件"><a href="#Step-2：生成-exec-文件" class="headerlink" title="Step-2：生成 exec 文件"></a>Step-2：生成 exec 文件</h3><p>exec 文件是 jacoco 默认的覆盖率数据文件类型，使用 on-the-fly 模式时，可以通过 Socket连接的方式，从远程服务器(即部署了 jacocoagent 的服务器) 上下载 exec 文件。JaCoCo 生成的 exec 文件是二进制文件，其中包含了代码覆盖率数据。它的结构如下：</p>
<p>Header（文件头部）：包含了 exec 文件的元数据信息，如版本号和会话标识符。<br>Sessions（会话信息）：存储了测试会话的信息，每个会话都有一个唯一的会话标识符。<br>Probes（探针信息）：存储了所有被覆盖的代码块的信息。每个代码块都有一个唯一的标识符，并且将内联代码的情况进行了处理。<br>Execution Data（执行数据）：实际的代码覆盖率数据。它记录了每个代码块是否被执行过。<br>具体来说，Header 部分包括以下信息：</p>
<p>Magic Number：一个特殊的标识符，用于识别文件类型。<br>Version：exec 文件的版本号。<br>Session Count：会话数量。<br>Session Infos：会话信息的起始位置。<br>Probe Count：探针数量。<br>Probe Infos：探针信息的起始位置。<br>Sessions 部分包括了每个会话的信息，例如会话标识符和会话名称。</p>
<p>Probes 部分包括了每个被覆盖的代码块的信息，例如代码块的标识符和分支相关的信息。</p>
<p>Execution Data 部分包括了实际的代码覆盖率数据，记录了每个代码块是否被执行过。</p>
<h3 id="Step-3：代码差异比对-增量覆盖率才有此步骤"><a href="#Step-3：代码差异比对-增量覆盖率才有此步骤" class="headerlink" title="Step-3：代码差异比对(增量覆盖率才有此步骤)"></a>Step-3：代码差异比对(增量覆盖率才有此步骤)</h3><p>code-diff 阶段用于比对代码差异，进而分析出代码变更点。代码变更包括以下几种情况：</p>
<p>新增，修改，删除不会被统计在内，因为文件已经被删除，不会产生覆盖率数据。如果是全量覆盖率报告生成，则会跳过此阶段。code-diff 功能使用 jgit 库和 javaparser 库的 API 实现。code-diff 流程如下：</p>
<p>下载采集分支代码，即新分支，如 feature，develop 等。<br>下载基准分支代码，即需要与之比较的分支，一般是 master 或者 release 等稳定分支。<br>使用 jgit 获取变更过得文件，即 java 源文件。<br>使用 javaparser 获取变更的类和方法，并记录方法信息(方法名，包名，方法签名等)。<br>生成 code-diff文件，用于后面生成增量报告。</p>
<h3 id="Step-4：代码编译"><a href="#Step-4：代码编译" class="headerlink" title="Step-4：代码编译"></a>Step-4：代码编译</h3><p>代码编译过程用于将 java 源代码编译成 class 文件，用于生成覆盖率报告，在生成 JaCoCo 报告时，需要使用 class 文件和源码文件主要是为了对覆盖率数据进行解析和展示。</p>
<p>Class 文件：JaCoCo 通过分析 class 文件来获取代码结构和字节码信息。它包含了类、方法和字段的定义、修饰符以及字节码指令等信息。通过分析 class 文件，JaCoCo 可以确定每个代码块（如行、分支等）的起始和结束位置。</p>
<p>源码文件：源码文件是编写程序的原始文件，其中包含了开发人员编写的代码。在生成覆盖率报告时，JaCoCo 将覆盖率数据与源码文件进行关联，并进行代码染色，以显示被执行和未执行的代码行。这样，开发人员可以清楚地看到哪些行被覆盖，哪些行未被覆盖。本服务支持 Gradle 项目和 maven 项目编译，编译工具版本如下：</p>
<ul>
<li>JDK：jdk11，jdk8</li>
<li>Gradle：gradle 7, gradle 6, gradle 5</li>
<li>Maven：maven 3.6.1</li>
</ul>
<h3 id="Step-5：报告生成"><a href="#Step-5：报告生成" class="headerlink" title="Step-5：报告生成"></a>Step-5：报告生成</h3><p>支持增量报告和全量报告生成。增量报告用于比较不同版本之间代码差异和覆盖率情况，全量报告直接展示新版本代码覆盖率情况。两种报告使用场景如下：</p>
<p>增量报告：</p>
<ul>
<li>新迭代差异代码覆盖情况，一般用于开发自测，检查变更的代码是否被执行</li>
</ul>
<p>全量报告：</p>
<ul>
<li>SIT 测试，通过代码覆盖情况间接表示功能覆盖情况</li>
<li>全量回归测试，比如机房迁移，项目重构等，会统计此分支下所有代码的执行情况</li>
</ul>
<h2 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h2><h3 id="代码同步"><a href="#代码同步" class="headerlink" title="代码同步"></a>代码同步</h3><p>直接使用 Jgit 即可，Maven 坐标如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jgit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.eclipse.jgit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.5.0.202303070854-r<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>示例代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">clone</span><span class="params">(String repoUrl, String branch, String localPath, String username, String password)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始克隆代码，代码库地址: &#123;&#125;&quot;</span>, repoUrl);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">CredentialsProvider</span> <span class="variable">credentialsProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordCredentialsProvider</span>(username, EncryptUtil.decryptByDes(password, desKey));</span><br><span class="line">        <span class="type">String</span> <span class="variable">savePath</span> <span class="operator">=</span> CoverageConstant.GIT_CLONE_TEMP_PATH + localPath;</span><br><span class="line">        log.info(<span class="string">&quot;git clone repoUrl: &#123;&#125;, branch: &#123;&#125;, savePath: &#123;&#125;&quot;</span>, repoUrl, branch, savePath);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Git</span> <span class="variable">ignored</span> <span class="operator">=</span> Git.cloneRepository()</span><br><span class="line">                .setURI(repoUrl)</span><br><span class="line">                .setBranch(branch)</span><br><span class="line">                .setCredentialsProvider(credentialsProvider)</span><br><span class="line">                .setDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(savePath))</span><br><span class="line">                .setDepth(<span class="number">1</span>)</span><br><span class="line">                .setCloneAllBranches(<span class="literal">false</span>)</span><br><span class="line">                .call()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;git clone success&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Git clone 异常,异常详情: &#123;&#125;&quot;</span>, ExceptionUtil.getErrorMessage(e));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;Git clone 异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;代码克隆完成，耗时: &#123;&#125; s, 代码库地址: &#123;&#125;&quot;</span>, (System.currentTimeMillis() - startTime) / <span class="number">1000</span>, repoUrl);</span><br><span class="line">        <span class="keyword">return</span> savePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="代码编译"><a href="#代码编译" class="headerlink" title="代码编译"></a>代码编译</h3><h4 id="Maven-项目编译"><a href="#Maven-项目编译" class="headerlink" title="Maven 项目编译"></a>Maven 项目编译</h4><p>Maven 项目使用 Maven embedder 进行编译<br>Maven 坐标如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-embedder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsr250-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.resolver<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resolver-connector-basic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.resolver<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resolver-transport-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>示例代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MavenBuildManagerImpl</span> <span class="keyword">implements</span> <span class="title class_">MavenBuildManager</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compiler</span><span class="params">(String codePath, List&lt;String&gt; commands)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始编译Maven项目，代码路径: &#123;&#125;, 编译参数: &#123;&#125;&quot;</span>, codePath, commands);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">File</span> <span class="variable">codeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(codePath);</span><br><span class="line">        <span class="keyword">if</span> (!codeFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;代码路径不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">MavenCli</span> <span class="variable">cli</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MavenCli</span>();</span><br><span class="line">        System.getProperties().setProperty(MavenCli.MULTIMODULE_PROJECT_DIRECTORY, MavenCli.USER_MAVEN_CONFIGURATION_HOME.getAbsolutePath());</span><br><span class="line">        <span class="comment">// 重定向标准错误输出流</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">errorStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">originalErrStream</span> <span class="operator">=</span> System.err;</span><br><span class="line">        System.setErr(<span class="keyword">new</span> <span class="title class_">PrintStream</span>(errorStream));</span><br><span class="line">        <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> cli.doMain(commands.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]), codePath, System.out, System.err);</span><br><span class="line">        <span class="comment">// 恢复标准错误输出流</span></span><br><span class="line">        System.setErr(originalErrStream);</span><br><span class="line">        <span class="keyword">if</span> (statusCode != <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;代码: &#123;&#125; 编译失败, 异常详情: &#123;&#125;&quot;</span>, codePath, errorStream);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;编译失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;结束编译Maven项目，编译耗时: &#123;&#125; s&quot;</span>, (System.currentTimeMillis() - startTime) / <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多模块代码扫描</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> codePath 代码路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 模块列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">modules</span><span class="params">(String codePath)</span> &#123;</span><br><span class="line">        List&lt;String&gt; modules;</span><br><span class="line">        <span class="type">File</span> <span class="variable">pomFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(codePath, <span class="string">&quot;pom.xml&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MavenXpp3Reader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MavenXpp3Reader</span>();</span><br><span class="line">            <span class="type">Model</span> <span class="variable">model</span> <span class="operator">=</span> reader.read(<span class="keyword">new</span> <span class="title class_">FileReader</span>(pomFile));</span><br><span class="line">            modules = model.getModules();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;代码: &#123;&#125; 模块扫描失败, 异常详情: &#123;&#125;&quot;</span>, codePath, ExceptionUtil.getErrorMessage(e));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;模块扫描失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> modules;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MavenCommand</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * maven命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MVN</span> <span class="operator">=</span> <span class="string">&quot;mvn&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清理构建产物</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLEAN</span> <span class="operator">=</span> <span class="string">&quot;clean&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编译 class 文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COMPILE</span> <span class="operator">=</span> <span class="string">&quot;compile&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;package&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳过测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SKIP_TEST</span> <span class="operator">=</span> <span class="string">&quot;-Dmaven.test.skip=true&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BATCH_MODE</span> <span class="operator">=</span> <span class="string">&quot;--batch-mode&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多核编译</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARALLEL</span> <span class="operator">=</span> <span class="string">&quot;-T 1C&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多线程编译</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FORK</span> <span class="operator">=</span> <span class="string">&quot;-Dmaven.compile.fork=true&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用编译命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; COMMAND = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()&#123;&#123;</span><br><span class="line">        add(CLEAN);</span><br><span class="line">        add(COMPILE);</span><br><span class="line">        add(SKIP_TEST);</span><br><span class="line">        add(BATCH_MODE);</span><br><span class="line">        add(PARALLEL);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="Gradle-项目编译"><a href="#Gradle-项目编译" class="headerlink" title="Gradle 项目编译"></a>Gradle 项目编译</h4><p>Gradle 项目使用 gradle tooling api进行编译<br>Maven 坐标如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.netbeans.external<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gradle-tooling-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>RELEASE170<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>示例代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradleBuildManagerImpl</span> <span class="keyword">implements</span> <span class="title class_">GradleBuildManager</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compiler</span><span class="params">(String gradlePath, String codePath, List&lt;String&gt; commands)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始编译Gradle项目，编译工具路径: &#123;&#125;，代码路径: &#123;&#125;, 编译参数: &#123;&#125;&quot;</span>, gradlePath, codePath, commands);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 重定向标准错误输出流</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">errorStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">originalErrStream</span> <span class="operator">=</span> System.err;</span><br><span class="line">        <span class="comment">// 重定向标准输出流</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">originalOutStream</span> <span class="operator">=</span> System.out;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ProjectConnection</span> <span class="variable">connection</span> <span class="operator">=</span> GradleConnector.newConnector()</span><br><span class="line">                .forProjectDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(codePath))</span><br><span class="line">                .useGradleUserHomeDir(CoverageConstant.DEFAULT_GRADLE_USER_HOME)</span><br><span class="line">                .useInstallation(<span class="keyword">new</span> <span class="title class_">File</span>(gradlePath))</span><br><span class="line">                .connect()) &#123;</span><br><span class="line">            <span class="type">BuildLauncher</span> <span class="variable">build</span> <span class="operator">=</span> connection.newBuild();</span><br><span class="line">            System.setErr(<span class="keyword">new</span> <span class="title class_">PrintStream</span>(errorStream));</span><br><span class="line">            System.setOut(<span class="keyword">new</span> <span class="title class_">PrintStream</span>(outputStream));</span><br><span class="line">            build.forTasks(commands.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]))</span><br><span class="line">                    .setStandardOutput(System.out)</span><br><span class="line">                    .setStandardError(System.err)</span><br><span class="line">                    <span class="comment">// 跳过单测，多线程编译</span></span><br><span class="line">                    .withArguments(GradleCommand.EXCLUDE, GradleCommand.TEST)</span><br><span class="line">                    <span class="comment">// 不使用彩色日志，否则会导致日志中的颜色代码被打印出来，导致日志不易阅读</span></span><br><span class="line">                    .setColorOutput(<span class="literal">false</span>)</span><br><span class="line">                    <span class="comment">// 限制 gradle 内存，防止编译过程中内存溢出</span></span><br><span class="line">                    .setJvmArguments(<span class="string">&quot;-Xmx512m&quot;</span>);</span><br><span class="line">            build.run();</span><br><span class="line">            log.info(<span class="string">&quot;编译日志:\n &#123;&#125;&quot;</span>, outputStream);</span><br><span class="line">            System.setErr(originalErrStream);</span><br><span class="line">            System.setOut(originalOutStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;代码: &#123;&#125; 编译失败, 异常详情: &#123;&#125;&quot;</span>, codePath, ExceptionUtil.getErrorMessage(e));</span><br><span class="line">            log.error(<span class="string">&quot;编译异常日志:\n &#123;&#125;&quot;</span>, errorStream);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;编译失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;结束编译Gradle项目，编译耗时: &#123;&#125; s&quot;</span>, (System.currentTimeMillis() - startTime) / <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">modules</span><span class="params">(String gradlePath, String codePath)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始扫描Gradle项目模块，编译工具路径: &#123;&#125;，代码路径: &#123;&#125;&quot;</span>, gradlePath, codePath);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ProjectConnection</span> <span class="variable">connection</span> <span class="operator">=</span> GradleConnector.newConnector()</span><br><span class="line">                .forProjectDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(codePath))</span><br><span class="line">                .useInstallation(<span class="keyword">new</span> <span class="title class_">File</span>(gradlePath))</span><br><span class="line">                .connect()) &#123;</span><br><span class="line">            <span class="type">GradleProject</span> <span class="variable">model</span> <span class="operator">=</span> connection.getModel(GradleProject.class);</span><br><span class="line">            <span class="keyword">return</span> model.getChildren().stream().map(GradleProject::getName).collect(Collectors.toList());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;代码: &#123;&#125; 模块扫描失败, 异常详情: &#123;&#125;&quot;</span>, codePath, ExceptionUtil.getErrorMessage(e));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;模块扫描失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradleCommand</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * gradle命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GRADLE</span> <span class="operator">=</span> <span class="string">&quot;gradle&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清理构建产物</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLEAN</span> <span class="operator">=</span> <span class="string">&quot;clean&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUILD</span> <span class="operator">=</span> <span class="string">&quot;build&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排除某个任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCLUDE</span> <span class="operator">=</span> <span class="string">&quot;-x&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TEST</span> <span class="operator">=</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多线程编译</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARALLEL</span> <span class="operator">=</span> <span class="string">&quot;-Dorg.gradle.parallel=true&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多进程编译</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FORK</span> <span class="operator">=</span> <span class="string">&quot;-Dorg.gradle.fork=true&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编译class文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLASSES</span> <span class="operator">=</span> <span class="string">&quot;classes&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用编译命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; COMMAND = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()&#123;&#123;</span><br><span class="line">        add(CLEAN);</span><br><span class="line">        add(CLASSES);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="差异代码比对"><a href="#差异代码比对" class="headerlink" title="差异代码比对"></a>差异代码比对</h3><p>直接参考这个就好：<a target="_blank" rel="noopener" href="https://gitee.com/Dray/code-diff/blob/master/src/main/java/com/dr/code/diff/service/impl/CodeDiffServiceImpl.java">https://gitee.com/Dray/code-diff/blob/master/src/main/java/com/dr/code/diff/service/impl/CodeDiffServiceImpl.java</a><br>原理就是直接通过jgit 分析出变更的文件，然后通过 javaparser 来分析代码</p>
<h3 id="覆盖率报告生成"><a href="#覆盖率报告生成" class="headerlink" title="覆盖率报告生成"></a>覆盖率报告生成</h3><p>生成报告参考这个：<a target="_blank" rel="noopener" href="https://gitee.com/Dray/code-diff/blob/master/src/main/java/com/dr/code/diff/jacoco/report/ReportAction.java">https://gitee.com/Dray/code-diff/blob/master/src/main/java/com/dr/code/diff/jacoco/report/ReportAction.java</a><br>但是里面涉及到差异报告生成，就需要使用这个仓库提供的 jar 了</p>
<h2 id="覆盖率报告解读"><a href="#覆盖率报告解读" class="headerlink" title="覆盖率报告解读"></a>覆盖率报告解读</h2><h3 id="全量覆盖率报告"><a href="#全量覆盖率报告" class="headerlink" title="全量覆盖率报告"></a>全量覆盖率报告</h3><h4 id="报告总览"><a href="#报告总览" class="headerlink" title="报告总览"></a>报告总览</h4><p><img src="/../images/3QSitfQz8xy1rjrZeT1Loxhs.png" alt="image.png"></p>
<ol>
<li>Element：被覆盖和测量的代码元素，通常是源代码的各种层级，比如 模块，包，类，方法。其实在jacoco的报告中，也是按照上面的层级逐步深入展示覆盖率报告的。</li>
<li>Instructions：指令覆盖，Java 字节指令的覆盖率。执行的最小单位，和代码的格式无关。</li>
<li>Branches：分支覆盖，如if分支，switch分支等。</li>
<li>Cxty：圈复杂度，Jacoco 会为每一个非抽象方法计算圈复杂度，并为类，包以及组（groups）计算复杂度。圈复杂度简单地说就是为了覆盖所有路径，所需要执行单元测试数量，圈复杂度大说明程序代码可能质量低且难于测试和维护。</li>
<li>Lines：行覆盖，只要本行有一条指令被执行，则本行则被标记为被执行。</li>
<li>Methods：方法覆盖，任何非抽象的方法，只要有一条指令被执行，则该方法就会被计为被执行。</li>
<li>Classes：类覆盖，所有类，包括接口，只要其中有一个方法被执行，则标记为被执行。注意：构造函数和静态初始化块也算作方法。</li>
<li>覆盖率数据：注意，上图中 1432 of 28186 94% 表示的意思是 一共有28186条指令，其中有1432条指令没有执行，94%≈(28186-1432)&#x2F;28186 * 100%</li>
</ol>
<h4 id="背景色及标记"><a href="#背景色及标记" class="headerlink" title="背景色及标记"></a>背景色及标记</h4><p>由于单行通常编译为多个字节代码指令，源代码突出显示为包含源代码的每行显示三种不同的状态</p>
<p>背景色：</p>
<ul>
<li>无覆盖：该行没有指令被执行（红色背景）</li>
<li>部分覆盖：仅执行了该行的部分指令（黄色背景）</li>
<li>全覆盖：该行所有指令均已执行（绿色背景）</li>
</ul>
<p>菱形标记：</p>
<ul>
<li>绿色菱形：这一行的所有分支都被执行</li>
<li>黄色菱形：这一行的分支中只有一部分被执行</li>
<li>红色菱形：在这一行中没有分支被执行</li>
</ul>
<p><img src="/../images/xKmTQwzgyHGMiDVCzNmwDe2z.png" alt="image.png"></p>
<p><img src="/../images/hCRXbhQguPR52jrdxQyekrM8.png" alt="image.png"></p>
<h3 id="增量覆盖率报告"><a href="#增量覆盖率报告" class="headerlink" title="增量覆盖率报告"></a>增量覆盖率报告</h3><p>增量覆盖率报告与全量覆盖率报告大体一致，只有部分标记存在差异。</p>
<ul>
<li>蓝色加号：新增的代码</li>
<li>黄色铅笔：修改过的代码</li>
</ul>
<p><img src="/../images/WRMqo5DnDnHg7HgYi9BvcNbD.png" alt="image.png"></p>
<h2 id="代码覆盖率接入常见问题"><a href="#代码覆盖率接入常见问题" class="headerlink" title="代码覆盖率接入常见问题"></a>代码覆盖率接入常见问题</h2><p>jacoco官方本身提供了FA&amp;Q，绝大多数覆盖率相关的问题都可以在这边找到，只有以下比较特殊的场景需要注意：</p>
<h3 id="反射导致的服务启动失败或者接口调用失败"><a href="#反射导致的服务启动失败或者接口调用失败" class="headerlink" title="反射导致的服务启动失败或者接口调用失败"></a>反射导致的服务启动失败或者接口调用失败</h3><p>jacoco不管是以何种方式运行，都会在class中插入static boolean[] $jacocoData 和 $jacocoInit() 来记录覆盖率数据。当我们使用反射来获取一个类的属性和方法时，很容易就获取到这两个特殊的Field，比如通过一个类来保存JDBC配置的时候，就会读到$jacocoData，导致jdbc连接失败。为了解决这个问题，需要在使用反射的地方通过如下方法处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ChromeDriver</span> <span class="variable">chromeDriver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChromeDriver</span>();</span><br><span class="line">    Field[] declaredFields = chromeDriver.getClass().getDeclaredFields();</span><br><span class="line">    <span class="keyword">for</span> (Field declaredField : declaredFields) &#123;</span><br><span class="line">        <span class="keyword">if</span> (declaredField.isSynthetic()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前属性: &quot;</span>+ declaredField.getName() +<span class="string">&quot;为合成属性，跳过...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Method[] declaredMethods = chromeDriver.getClass().getDeclaredMethods();</span><br><span class="line">    <span class="keyword">for</span> (Method declaredMethod : declaredMethods) &#123;</span><br><span class="line">        <span class="keyword">if</span> (declaredMethod.isSynthetic()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前方法: &quot;</span>+ declaredMethod.getName() +<span class="string">&quot;为合成方法，跳过...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于 isSynthetic() 的解释可以参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/dotnet/api/java.lang.class.issynthetic">Class.IsSynthetic 属性 (Java.Lang)</a></p>
</blockquote>
<h2 id="写在最后的话"><a href="#写在最后的话" class="headerlink" title="写在最后的话"></a>写在最后的话</h2><p>准备提桶了，没啥心情写了，就先写这么多吧，希望诸位都能找到合适的工作<br>PS：代码编译比较耗费资源，记得改成 mq，触发任务采集的时候通过 mq 来做任务排队</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.jacoco.org/jacoco/trunk/doc/">https://www.jacoco.org/jacoco/trunk/doc/</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/Dray/jacoco">https://gitee.com/Dray/jacoco</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/Dray/code-diff">https://gitee.com/Dray/code-diff</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Huang1178387848/article/details/114399056">https://blog.csdn.net/Huang1178387848/article/details/114399056</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/ref/3-LATEST/maven-embedder/index.html">https://maven.apache.org/ref/3-LATEST/maven-embedder/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/ByteDanceTech/article/details/123059368">https://blog.csdn.net/ByteDanceTech/article/details/123059368</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jacoco.org/jacoco/trunk/doc/mission.html">https://www.jacoco.org/jacoco/trunk/doc/mission.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jacoco.org/jacoco/trunk/doc/counters.html">https://www.jacoco.org/jacoco/trunk/doc/counters.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jacoco.org/jacoco/trunk/doc/agent.html">https://www.jacoco.org/jacoco/trunk/doc/agent.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jacoco.org/jacoco/trunk/doc/cli.html">https://www.jacoco.org/jacoco/trunk/doc/cli.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jacoco.org/jacoco/trunk/doc/faq.html">https://www.jacoco.org/jacoco/trunk/doc/faq.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/tushuping/article/details/134347325">https://blog.csdn.net/tushuping/article/details/134347325</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/tushuping/article/details/112613528">https://blog.csdn.net/tushuping/article/details/112613528</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/tushuping/article/details/131640959">https://blog.csdn.net/tushuping/article/details/131640959</a></li>
</ol>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://linvaux.github.io/2024/07/26/%E5%9F%BA%E4%BA%8E-Jacoco-%E7%9A%84-java-%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1/" title="基于 Jacoco 的 java 代码覆盖率收集服务设计" target="_blank" rel="external">https://linvaux.github.io/2024/07/26/基于-Jacoco-的-java-代码覆盖率收集服务设计/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://gitee.com/linvaux" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar1.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://gitee.com/linvaux" target="_blank"><span class="text-dark">大耳朵图图</span><small class="ml-1x">Java开发/高级测试开发</small></a></h3>
        <div>一个持续学习的靓仔</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2024/07/26/%E5%9F%BA%E4%BA%8EJmeter%E5%92%8CSelenium%E7%9A%84WebUI%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF/" title="基于Jmeter和Selenium的WebUI自动化测试服务实现思路"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2024/07/26/Java-%E9%9B%86%E6%88%90Maven-Embedder-%E7%BC%96%E8%AF%91-Maven-%E9%A1%B9%E7%9B%AE/" title="Java 集成Maven Embedder 编译 Maven 项目"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://gitee.com/linvaux" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>



    <script>
(function ($) {
    $('.search-form').on('submit', function (e) {
        var keyword = $('.search-form-input[name="wd"]').val();
        window.location = 'https://www.baidu.com/s?wd=site:linvaux.github.io ' + keyword;
        return false;
    });
})(jQuery);
</script>




   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   


  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>