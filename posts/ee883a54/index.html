<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>FileBeat+LogStash实现MySQL慢查询日志解析 | 写bug的大耳朵图图</title><meta name="description" content="背景是一个大型营销系统经常出现mysql的慢查询，导致线上服务频繁出现故障，为了查看是哪些sql有问题，并且要支持各种维度的统计查询，所以使用FileBeat+LogStash+ElasticSearch+Kibana实现此需求。本文仅描述如何配置FileBeath和LogStash实现MySQL慢查询日志解析。  FileBeat配置12345678910111213141516171819f"><meta property="og:type" content="article"><meta property="og:title" content="FileBeat+LogStash实现MySQL慢查询日志解析"><meta property="og:url" content="https://linvaux.github.io/posts/ee883a54/index.html"><meta property="og:site_name" content="写bug的大耳朵图图"><meta property="og:description" content="背景是一个大型营销系统经常出现mysql的慢查询，导致线上服务频繁出现故障，为了查看是哪些sql有问题，并且要支持各种维度的统计查询，所以使用FileBeat+LogStash+ElasticSearch+Kibana实现此需求。本文仅描述如何配置FileBeath和LogStash实现MySQL慢查询日志解析。  FileBeat配置12345678910111213141516171819f"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-07-26T13:42:18.000Z"><meta property="article:modified_time" content="2024-09-21T00:59:08.922Z"><meta property="article:author" content="Wick"><meta property="article:tag" content="LogStash"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://linvaux.github.io/posts/ee883a54/index.html"><link rel="alternate" href="/atom.xml" title="写bug的大耳朵图图" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://gitee.com/linvaux" target="_blank"><img class="img-circle img-rotate" src="/images/avatar1.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">大耳朵图图</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Java开发/高级测试开发</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> 中国·南京</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form" method="GET" action="https://www.baidu.com/s?"><div class="input-group"><input name="wd" type="text" class="form-control search-form-input" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="btn btn-flat search-form-submit"><i class="icon icon-search"></i></button></span></div></form></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><h5>原博客地址：<a href="https://geeknote.net/wick">https://geeknote.net/wick</a></h5></div></div></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Docker/" style="font-size:13.6px">Docker</a> <a href="/tags/EasyExcel/" style="font-size:13.4px">EasyExcel</a> <a href="/tags/IDEA/" style="font-size:13.4px">IDEA</a> <a href="/tags/Java/" style="font-size:14px">Java</a> <a href="/tags/Jenkins/" style="font-size:13px">Jenkins</a> <a href="/tags/Jmeter%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size:13px">Jmeter扩展开发</a> <a href="/tags/Jmeter%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/" style="font-size:13.8px">Jmeter源码系列</a> <a href="/tags/LogStash/" style="font-size:13px">LogStash</a> <a href="/tags/Mac/" style="font-size:13px">Mac</a> <a href="/tags/Pytest/" style="font-size:13px">Pytest</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87/" style="font-size:13.2px">代码覆盖率</a> <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size:13px">自动化测试</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size:13px">随笔</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/posts/a7b6bddb/" class="title">Github Pages使用Hexo搭建个人博客</a></p><p class="item-date"><time datetime="2024-08-24T13:59:39.000Z" itemprop="datePublished">2024-08-24</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/posts/fbd833ae/" class="title">Jmeter源码系列(5)-JmeterEngine-Jmeter的执行引擎</a></p><p class="item-date"><time datetime="2024-08-04T04:41:26.000Z" itemprop="datePublished">2024-08-04</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/posts/75270eba/" class="title">【Jmeter扩展开发】自定义Java请求</a></p><p class="item-date"><time datetime="2024-08-03T01:36:37.000Z" itemprop="datePublished">2024-08-03</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/posts/67f865da/" class="title">IDEA插件整理(二)</a></p><p class="item-date"><time datetime="2024-07-31T14:02:28.000Z" itemprop="datePublished">2024-07-31</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/posts/7d6bf7a5/" class="title">Jmeter源码系列(4) - Jmeter 类详解-runNonGui()，无界面模式下的脚本执行过程</a></p><p class="item-date"><time datetime="2024-07-28T14:03:54.000Z" itemprop="datePublished">2024-07-28</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-FileBeat-LogStash实现MySQL慢查询日志解析" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">FileBeat+LogStash实现MySQL慢查询日志解析</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/posts/ee883a54/" class="article-date"><time datetime="2020-07-26T13:42:18.000Z" itemprop="datePublished">2020-07-26</time> </a></span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/LogStash/" rel="tag">LogStash</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/posts/ee883a54/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 1.5k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 8(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><blockquote><p>背景是一个大型营销系统经常出现mysql的慢查询，导致线上服务频繁出现故障，为了查看是哪些sql有问题，并且要支持各种维度的统计查询，所以使用FileBeat+LogStash+ElasticSearch+Kibana实现此需求。本文仅描述如何配置FileBeath和LogStash实现MySQL慢查询日志解析。</p></blockquote><h1 id="FileBeat配置"><a href="#FileBeat配置" class="headerlink" title="FileBeat配置"></a>FileBeat配置</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 忽略在指定的时间跨度之前被修改的文件</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">30000h</span></span><br><span class="line">  <span class="comment"># mysql慢查询日志目录，支持*通配符匹配多级目录</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/opt/slow-sql/*.log</span></span><br><span class="line">  <span class="comment"># 文档类型是mysqlslow，这是filebeat内置的一套规则</span></span><br><span class="line">  <span class="attr">document_type:</span> <span class="string">mysqlslow</span></span><br><span class="line">  <span class="attr">multiline:</span></span><br><span class="line">    <span class="attr">pattern:</span> <span class="string">&quot;^# User@Host: &quot;</span></span><br><span class="line">    <span class="attr">negate:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">match:</span> <span class="string">after</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="comment"># logstash的地址，我是部署在同一台机器上的</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;127.0.0.1:5044&quot;</span>]</span><br></pre></td></tr></table></figure><h1 id="LogStash配置"><a href="#LogStash配置" class="headerlink" title="LogStash配置"></a>LogStash配置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  # 使用filebeat推送日志</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line">    host =&gt; &quot;0.0.0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    # 有数据库名，有schema</span><br><span class="line">    match =&gt; &#123;&quot;message&quot; =&gt; &quot;(?m)^# User@Host: %&#123;USER:user&#125;\[[^\]]+\]\s@\s*\[%&#123;IP:clientip&#125;\]\s*([\s\S]*)#\s+Schema: (?&lt;schema&gt;\w+)([\s\S]*)\s+#\s+Query_time:\s+%&#123;NUMBER:query_time:float&#125;\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;\s*([\s\S]*)use\s(?&lt;dbname&gt;\w+);([\s\S]*)SET timestamp=%&#123;NUMBER:sql_time:int&#125;&quot;&#125;</span><br><span class="line">    # 无数据库名,有schema</span><br><span class="line">    match =&gt; &#123;&quot;message&quot; =&gt; &quot;(?m)^# User@Host: %&#123;USER:user&#125;\[[^\]]+\]\s@\s*\[%&#123;IP:clientip&#125;\]\s*([\s\S]*)#\s+Schema: (?&lt;schema&gt;\w+)([\s\S]*)\s+#\s+Query_time:\s+%&#123;NUMBER:query_time:float&#125;\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;\s*([\s\S]*)SET timestamp=%&#123;NUMBER:sql_time:int&#125;&quot;&#125;</span><br><span class="line">    # 有数据库名，无schema</span><br><span class="line">    match =&gt; &#123;&quot;message&quot; =&gt; &quot;(?m)^# User@Host: %&#123;USER:user&#125;\[[^\]]+\]\s@\s*\[%&#123;IP:clientip&#125;\]\s*([\s\S]*)#\s+Query_time:\s+%&#123;NUMBER:query_time:float&#125;\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;\s*([\s\S]*)use\s(?&lt;dbname&gt;\w+);([\s\S]*)SET timestamp=%&#123;NUMBER:sql_time:int&#125;&quot;&#125;</span><br><span class="line">    # 无数据库名,无schema</span><br><span class="line">    match =&gt; &#123;&quot;message&quot; =&gt; &quot;(?m)^# User@Host: %&#123;USER:user&#125;\[[^\]]+\]\s@\s*\[%&#123;IP:clientip&#125;\]\s*([\s\S]*)#\s+Query_time:\s+%&#123;NUMBER:query_time:float&#125;\s+Lock_time: %&#123;NUMBER:lock_time:float&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent:int&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined:int&#125;\s*([\s\S]*)SET timestamp=%&#123;NUMBER:sql_time:int&#125;&quot;&#125;</span><br><span class="line">    overwrite =&gt; [&quot;message&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  grok&#123;</span><br><span class="line">      # 匹配 source中的ip</span><br><span class="line">    match =&gt; &#123;&quot;source&quot; =&gt; &quot;(?m)\s*%&#123;IP:server_ip&#125;&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 时间戳格式化并只保留日期</span><br><span class="line">  ruby &#123;</span><br><span class="line">    code =&gt; &quot;</span><br><span class="line">      require &#x27;time&#x27;</span><br><span class="line">      event.set(&#x27;date_tag&#x27;, Time.at(event.get(&#x27;sql_time&#x27;)).to_date.to_s.delete!(&#x27;-&#x27;))</span><br><span class="line">    &quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 索引时间戳使用sql生成的时间，不再使用当前时间</span><br><span class="line">  date &#123;</span><br><span class="line">      match =&gt; [&quot;sql_time&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;, &quot;UNIX&quot;]</span><br><span class="line">      target =&gt; &quot;@timestamp&quot;</span><br><span class="line">      locale =&gt; &quot;cn&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  # 调试时使用，在控制台打印日志分割结果</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; rubydebug &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  # es配置</span><br><span class="line"> elasticsearch &#123; </span><br><span class="line">    hosts =&gt; &quot;localhost:9200&quot; </span><br><span class="line">    # 索引名称</span><br><span class="line">    index =&gt; &quot;slow-sql-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="一键安装ELFK"><a href="#一键安装ELFK" class="headerlink" title="一键安装ELFK"></a>一键安装ELFK</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------------------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">@Author: linvaux</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">@Email: linvaux@outlook.com</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">@Desc: Auto install ELFK</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">----------------------------------------</span></span><br><span class="line">&quot;</span><br><span class="line">INFO()</span><br><span class="line">&#123;</span><br><span class="line">    echo -e &quot;\033[0;32m[INFO] $* \033[0m&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ERROR()</span><br><span class="line">&#123;</span><br><span class="line">    echo -e &quot;\033[0;31m[ERROR] $* \033[0m&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WARN()</span><br><span class="line">&#123;</span><br><span class="line">    echo -e &quot;\033[0;33m[WARN] $* \033[0m&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">booster the docker-hub</span></span><br><span class="line">booster()</span><br><span class="line">&#123;   </span><br><span class="line">    daemon=&quot;/etc/docker/daemon.json&quot;</span><br><span class="line">    if [[ -e $&#123;daemon&#125; ]];then</span><br><span class="line">        INFO Backup $&#123;daemon&#125; success!</span><br><span class="line">        mv $&#123;daemon&#125; $&#123;daemon&#125;.bak</span><br><span class="line">        echo &quot;&#123;\&quot;registry-mirrors\&quot; : [\&quot;https://hub-mirror.c.163.com\&quot;]&#125;&quot; &gt; $&#123;daemon&#125;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;&#123;\&quot;registry-mirrors\&quot; : [\&quot;https://hub-mirror.c.163.com\&quot;]&#125;&quot; &gt; $&#123;daemon&#125;</span><br><span class="line">    fi</span><br><span class="line">    INFO Config docker-hub booster success!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_env()</span><br><span class="line">&#123;</span><br><span class="line">    if [[ -z &quot;$(which docker)&quot; ]]</span><br><span class="line">    then</span><br><span class="line">        WARN  No docker were found,try to install! </span><br><span class="line">        INFO  Start to install docker </span><br><span class="line">        source /etc/os-release</span><br><span class="line">        if [[ &quot;$ID&quot; == &quot;ubuntu&quot; ]] || [[ &quot;$ID&quot; == &quot;debain&quot; ]]</span><br><span class="line">        then</span><br><span class="line">            apt update</span><br><span class="line">            apt install curl wget -y</span><br><span class="line">            curl -fsSL https://get.docker.com | sh</span><br><span class="line">            booster</span><br><span class="line">            systemctl daemon-reload</span><br><span class="line">            systemctl restart docker</span><br><span class="line">            if [[ -z &quot;$(which java)&quot; ]];then</span><br><span class="line">                apt install openjdk-8-jdk -y</span><br><span class="line">            fi</span><br><span class="line">        elif [[ &quot;$ID&quot; == &quot;centos&quot; ]]</span><br><span class="line">        then</span><br><span class="line">            yum update -y</span><br><span class="line">            yum install  wget curl net-tools -y</span><br><span class="line">            curl -fsSL https://get.docker.com | sh</span><br><span class="line">            booster</span><br><span class="line">            systemctl daemon-reload</span><br><span class="line">            systemctl restart docker</span><br><span class="line">            if [[ -z &quot;$(which java)&quot; ]];then</span><br><span class="line">                yum install java-1.8.0-openjdk -y</span><br><span class="line">            fi</span><br><span class="line">        else</span><br><span class="line">            ERROR  Could not support $ID platform! </span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_elasticsearch()</span><br><span class="line">&#123;</span><br><span class="line">    INFO Start to install elasticsearch</span><br><span class="line">	echo &quot;vm.max_map_count=655360&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">	sysctl -p</span><br><span class="line">    docker pull docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br><span class="line">    docker run -d --restart=always -p 9200:9200 -p 9300:9300 --name es -h es -e cluster.name=kiki -e node.name=node1 -e http.cors.enabled=true -e http.cors.allow-origin=&quot;*&quot; -e xpack.security.enabled=false docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_kibana()</span><br><span class="line">&#123;</span><br><span class="line">    INFO Start to install kibana</span><br><span class="line">    docker pull kibana:6.5.4;</span><br><span class="line">    docker run --restart=always -p 5601:5601 --name kibana -e ELASTICSEARCH_URL=http://127.0.0.1:9200 --network=host  -d kibana:6.5.4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_filebeat_and_logstash()</span><br><span class="line">&#123;</span><br><span class="line">	INFO Start to install filebeat and logstash</span><br><span class="line">    source /etc/os-release</span><br><span class="line">    if [[ &quot;$ID&quot; == &quot;ubuntu&quot; ]] || [[ &quot;$ID&quot; == &quot;debain&quot; ]]</span><br><span class="line">    then</span><br><span class="line">		wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -</span><br><span class="line">		apt-get install apt-transport-https -y</span><br><span class="line">		echo &quot;deb https://artifacts.elastic.co/packages/6.x/apt stable main&quot; | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list</span><br><span class="line">		apt-get update &amp;&amp; apt install filebeat logstash -y</span><br><span class="line">		if [[ $? -ne 0 ]]</span><br><span class="line">		then</span><br><span class="line">       		ERROR  Install filebeat and logstash failed! </span><br><span class="line">            exit 1</span><br><span class="line">		fi</span><br><span class="line">    elif [[ &quot;$ID&quot; == &quot;centos&quot; ]]</span><br><span class="line">    then</span><br><span class="line">        rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">		echo -e &#x27;</span><br><span class="line">[elastic-6.x]</span><br><span class="line">name=Elastic repository for 6.x packages</span><br><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br><span class="line">&#x27; &gt; /etc/yum.repos.d/elastic.io.repo</span><br><span class="line">		yum makecache &amp;&amp; yum install filebeat logstash -y</span><br><span class="line">		if [[ $? -ne 0 ]]</span><br><span class="line">        then</span><br><span class="line">            ERROR  Install filebeat and logstash failed! </span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        ERROR  Could not support $ID platform! </span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start_filebeat()</span><br><span class="line">&#123;</span><br><span class="line">    INFO Start to call filebeat</span><br><span class="line">    filebeat_yaml=&quot;/etc/filebeat/filebeat.yml&quot;</span><br><span class="line">    if [[ -f $&#123;filebeat_yaml&#125; ]];then</span><br><span class="line">        mv $&#123;filebeat_yaml&#125; $&#123;filebeat_yaml&#125;.bak</span><br><span class="line">        cp ./filebeat.yml $&#123;filebeat_yaml&#125;</span><br><span class="line">        systemctl restart filebeat</span><br><span class="line">        if [[ $? -ne 0 ]]</span><br><span class="line">        then</span><br><span class="line">            ERROR  Start filebeat failed! </span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        ERROR $&#123;filebeat_yaml&#125; not found, please check!</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start_logstash()</span><br><span class="line">&#123;</span><br><span class="line">    INFO Start to call logstash</span><br><span class="line">    logstash_conf_dir=&quot;/etc/logstash/conf.d/&quot;</span><br><span class="line">    if [[ -e $&#123;logstash_conf_dir&#125; ]];then</span><br><span class="line">        cp ./slow_sql_by_query.conf $&#123;logstash_conf_dir&#125;</span><br><span class="line">        systemctl restart logstash</span><br><span class="line">        if [[ $? -ne 0 ]]</span><br><span class="line">        then</span><br><span class="line">            ERROR  Start logstash failed! </span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        ERROR $&#123;logstash_conf_dir&#125; not found, please check!</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run()</span><br><span class="line">&#123;</span><br><span class="line">	if [[ &quot;root&quot; == $(whoami) ]]</span><br><span class="line">	then</span><br><span class="line">		INFO Start to run...</span><br><span class="line">		check_env</span><br><span class="line">		install_elasticsearch</span><br><span class="line">		install_kibana</span><br><span class="line">		install_filebeat_and_logstash</span><br><span class="line">        # download_log</span><br><span class="line">        start_logstash</span><br><span class="line">        start_filebeat</span><br><span class="line">        # check_index</span><br><span class="line">        INFO Run success!</span><br><span class="line">	else</span><br><span class="line">		ERROR Run as root please!	</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run</span><br></pre></td></tr></table></figure></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://linvaux.github.io/posts/ee883a54/" title="FileBeat+LogStash实现MySQL慢查询日志解析" target="_blank" rel="external">https://linvaux.github.io/posts/ee883a54/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://gitee.com/linvaux" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar1.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://gitee.com/linvaux" target="_blank"><span class="text-dark">大耳朵图图</span><small class="ml-1x">Java开发/高级测试开发</small></a></h3><div>一个持续学习的靓仔</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/posts/4938c154/" title="Pytest参数"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/posts/cb5702fa/" title="基于Ubuntu16.04的Python3.7镜像构建"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>(o=>{o(".search-form").on("submit",function(i){var n=o('.search-form-input[name="wd"]').val();return window.location="https://www.baidu.com/s?wd=site:linvaux.github.io "+n,!1})})(jQuery)</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script></body></html>